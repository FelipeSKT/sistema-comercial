<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema da Fam√≠lia</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header class="cabecalho-topo">
    <nav class="links-navegacao">
        <a href="/index.html">Gerir Clientes</a>
        <a href="/produtos.html">Gerir Produtos</a>
        <a href="/estoque.html">Gerir Estoque</a>
    </nav>

    <div class="logo-area">
        <img src="/img/logo.png" alt="Logo Rinamed" class="logo-imagem">
    </div>
</header>

<br>

<div class="container">
    <h1 id="tituloPagina"> Cadastro de Cliente</h1>

    <input type="hidden" id="campoId">

    <div>
        <label>Nome:</label>
        <input type="text" id="campoNome">
    </div>
    <div>
        <label>CPF:</label>
        <input type="text" id="campoCpf">
    </div>

    <div>
        <label>Numero:</label>
        <input type="text" id="campoNumero">
    </div>

    <div>
        <label>Endereco:</label>
        <input type="text" id="campoEndereco">
    </div>

    <br>
    <button id="btnSalvar" onclick="cadastrar()">Salvar Cliente</button>
</div>

<div style="margin-top: 30px; margin-bottom: 20px; display: flex;">
    <input type="text" id="campoBuscaCliente" placeholder="Buscar por Nome ou CPF..."
           onkeyup="if(event.keyCode === 13) carregarClientes()">
    <button onclick="carregarClientes()"
            style="width: auto; padding: 10px 15px; margin-left: 10px; background-color: #6c757d; color: white; border-radius: 4px;">
        üîç Buscar
    </button>
</div>

<hr> <h2>Lista de Clientes</h2>

<table border="1" style="width: 100%; text-align: left;">
    <thead>
    <tr>
        <th>Nome</th>
        <th>CPF</th>
        <th>Telefone</th>
        <th>Endere√ßo</th>
        <th>A√ß√µes</th>
    </tr>
    </thead>
    <tbody id="tabelaClientes">
    </tbody>
</table>

<script>

    let clientesAtuais = [];

    function cadastrar() {
        // 1. Pegar os dados (incluindo o ID escondido)
        let idDigitado = document.getElementById("campoId").value;
        let nomeDigitado = document.getElementById("campoNome").value;
        let cpfDigitado = document.getElementById("campoCpf").value;
        let numberDigitado = document.getElementById("campoNumero").value;
        let addressDigitado = document.getElementById("campoEndereco").value;

        cpfDigitado = cpfDigitado.replace(/\D/g, "");
        numberDigitado = numberDigitado.replace(/\D/g, "");

        if (nomeDigitado == ""){
            alert("O nome √© obrigat√≥rio!");
            return;
        }
        if (cpfDigitado == ""){
            alert("O CPF √© obrigat√≥rio!");
            return;
        }
        if (cpfDigitado.length != 11){
            alert("O CPF Esta incorreto");
            return;
        }
        if (numberDigitado == ""){
            alert("O Numero √© obrigat√≥rio");
            return;
        }
        if ( numberDigitado.length != 11){
            alert("O Numero esta incorreto");
            return;
        }

        // 2. Montar o pacote de dados
        let dados = {
            id: idDigitado ? idDigitado : null, // O truque do ID!
            name: nomeDigitado,
            cpf: cpfDigitado,
            number: numberDigitado,
            address: addressDigitado
        };

        // 3. Enviar para o Java
        fetch('/cliente', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        })
            .then(resposta => resposta.text()) // O Java devolve um texto de sucesso
            .then(texto => {
                alert(texto); // Avisa o usu√°rio

                limparFormulario();
                carregarClientes();
            })
            .catch(erro => console.error('Erro:', erro));
    }

    function carregarClientes() {
        let termoBusca = document.getElementById("campoBuscaCliente").value;
        let url = '/clientes';

        if (termoBusca) {
            // Adiciona o par√¢metro de busca √† URL
            url = `/clientes?q=${encodeURIComponent(termoBusca)}`;
        }

        fetch(url) // Usa a URL com ou sem o par√¢metro 'q'
            .then(resposta => resposta.json())
            .then(listaClientes => {

                clientesAtuais = listaClientes

                let tabela = document.getElementById("tabelaClientes");
                tabela.innerHTML = "";
                listaClientes.forEach(cliente => {
                    tabela.innerHTML += `
                    <tr>
                        <td>${cliente.name}</td>
                        <td>${cliente.cpf}</td>
                        <td>${cliente.number}</td>
                        <td>${cliente.address}</td>
                        <td>
                           <button class="btn-editar" onclick="prepararEdicao(${cliente.id})">Editar</button>
                           <button class="btn-excluir" onclick="excluir(${cliente.id})">Excluir</button>
                        </td>
                    </tr>
                `;
                });
            })
            .catch(erro => console.error('Erro:', erro));
    }

    carregarClientes();

    function excluir(id) {
        // √â sempre bom confirmar antes de apagar!
        if (confirm("Tens a certeza que queres eliminar este cliente?")) {

            fetch(`/cliente/${id}`, {
                method: 'DELETE'
            })
                .then(resposta => {
                    if (resposta.ok) {
                        alert("Cliente removido com sucesso!");
                        // Recarregamos a lista para ver a tabela atualizada sem o cliente
                        carregarClientes();
                    } else {
                        alert("Ops! Algo correu mal.");
                    }
                })
                .catch(erro => console.error('Erro:', erro));
        }
    }

    function prepararEdicao(id) {
        // Rastreadores:
        console.log("Tentando editar o ID:", id);
        console.log("Minha mem√≥ria de clientes tem:", clientesAtuais);

        // Acha o cliente na lista pelo ID
        let clienteEncontrado = clientesAtuais.find(c => c.id == id);

        console.log("O resultado da busca foi:", clienteEncontrado);

        if (clienteEncontrado) {
            document.getElementById("tituloPagina").innerText = "Editar Cliente";
            document.getElementById("btnSalvar").innerText = "Atualizar";
            document.getElementById("campoId").value = clienteEncontrado.id;
            document.getElementById("campoNome").value = clienteEncontrado.name;
            document.getElementById("campoCpf").value = clienteEncontrado.cpf;
            document.getElementById("campoNumero").value = clienteEncontrado.number;
            document.getElementById("campoEndereco").value = clienteEncontrado.address;
        }
    }

    function limparFormulario() {
        // 1. Resetar o visual (T√≠tulo e Bot√£o)
        document.getElementById("tituloPagina").innerText = "Cadastro de Cliente";
        document.getElementById("btnSalvar").innerText = "Salvar Cliente";
        document.getElementById("campoId").value = "";
        document.getElementById("campoId").value = "";
        document.getElementById("campoNome").value = "";
        document.getElementById("campoCpf").value = "";
        document.getElementById("campoNumero").value = "";
        document.getElementById("campoEndereco").value = "";
    }

</script>

</body>
</html>